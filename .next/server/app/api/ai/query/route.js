"use strict";(()=>{var e={};e.id=717,e.ids=[717],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5315:e=>{e.exports=require("path")},6563:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>w,requestAsyncStorage:()=>h,routeModule:()=>m,serverHooks:()=>g,staticGenerationAsyncStorage:()=>d});var o={};r.r(o),r.d(o,{POST:()=>_});var n=r(9303),a=r(8716),i=r(670),s=r(7070),l=r(3697),u=r(4574),c=r(2875),p=r(7830),y=r(2460);async function _(e){try{let{question:t,filters:r={}}=await e.json();if(!t)return s.NextResponse.json({error:"Question is required"},{status:400});let{year:o,theme:n,institution:a}=r,i=(0,y.iu)("query",{question:t,filters:r}),_=(0,y.q9)(i);if(_)return s.NextResponse.json(_);let{data:m}=await (0,l._)({year:o,institution:a,theme:n,search:t,limit:20});if(0===m.length)return s.NextResponse.json({answer:"I couldn't find any relevant outlook calls matching your criteria to answer this question.",sources:[],follow_up_questions:["Try broadening your search filters.","Ask about a specific theme or bank."]});let h=m.map(e=>`[${e.id}] ${e.institutionCanonical} (${e.year}): "${e.callText}"`).join("\n\n"),d=await (0,c.x)("query",{question:t,context:h}),g=await (0,u.f)([{role:"system",content:"You are a helpful research assistant."},{role:"user",content:d}],{temperature:.2}),f=(0,p.a6)(g,p.Cm);return(0,y.Zi)(i,f),s.NextResponse.json(f)}catch(e){return console.error("API Error:",e),s.NextResponse.json({error:"Internal Server Error"},{status:500})}}let m=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/ai/query/route",pathname:"/api/ai/query",filename:"route",bundlePath:"app/api/ai/query/route"},resolvedPagePath:"C:\\1 Projects\\secular_forum\\secular_hub\\app\\api\\ai\\query\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:h,staticGenerationAsyncStorage:d,serverHooks:g}=m,f="/api/ai/query/route";function w(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:d})}},2460:(e,t,r)=>{r.d(t,{Zi:()=>a,iu:()=>i,q9:()=>n});let o=new(r(138)).z({max:100,ttl:36e5,allowStale:!1});function n(e){return o.get(e)}function a(e,t,r){o.set(e,t,{ttl:r})}function i(e,t){let r=Object.keys(t).sort().map(e=>`${e}:${JSON.stringify(t[e])}`).join("|");return`${e}|${r}`}},4574:(e,t,r)=>{let o;r.d(t,{f:()=>i});var n=r(1088);let a=!!process.env.AZURE_OPENAI_ENDPOINT;async function i(e,t={}){try{let r=process.env.AZURE_OPENAI_DEPLOYMENT_NAME||"gpt-4";return(await o.chat.completions.create({model:a?r:"gpt-4-turbo",messages:e,temperature:t.temperature??.7,max_tokens:t.max_tokens??1e3})).choices[0].message.content}catch(e){throw console.error("Error calling AI service:",e),e}}a?(process.env.AZURE_OPENAI_KEY&&process.env.AZURE_OPENAI_ENDPOINT||console.warn("Azure OpenAI credentials missing. AI features may not work."),o=new n.r3({apiKey:process.env.AZURE_OPENAI_KEY,endpoint:process.env.AZURE_OPENAI_ENDPOINT,deployment:process.env.AZURE_OPENAI_DEPLOYMENT_NAME,apiVersion:"2024-05-01-preview"})):(process.env.OPENAI_API_KEY||console.warn("OpenAI API Key missing. AI features may not work."),o=new n.ZP({apiKey:process.env.OPENAI_API_KEY}))},7830:(e,t,r)=>{r.d(t,{Cm:()=>s,a6:()=>l,aN:()=>i,h6:()=>n,rw:()=>a});var o=r(6543);let n=o.Ryn({summary:o.Z_8(),key_themes:o.IXX(o.Z_8()),dominant_view:o.Z_8(),notable_outliers:o.IXX(o.Ryn({institution:o.Z_8(),view:o.Z_8()})),confidence:o.KmV(["high","medium","low"])}),a=o.Ryn({sentiment:o.KmV(["bullish","bearish","neutral","mixed"]),confidence:o.Rxh().min(0).max(1),key_phrases:o.IXX(o.Z_8())}),i=o.Ryn({narrative:o.Z_8(),sections:o.Ryn({whats_new:o.Z_8(),whats_intensified:o.Z_8(),whats_faded:o.Z_8(),notable_reversals:o.Z_8()}),key_shifts:o.IXX(o.Ryn({theme:o.Z_8(),direction:o.Z_8(),driver:o.Z_8()}))}),s=o.Ryn({answer:o.Z_8(),sources:o.IXX(o.Ryn({id:o.Z_8(),institution:o.Z_8(),excerpt:o.Z_8()})),follow_up_questions:o.IXX(o.Z_8())});function l(e,t){if(!e)throw Error("Empty AI response");let r=e.trim();if(r.startsWith("```")){let e=r.split("\n");e[0].startsWith("```")&&e.shift(),e[e.length-1].startsWith("```")&&e.pop(),r=e.join("\n")}try{let e=JSON.parse(r);return t.parse(e)}catch(t){throw console.error("Failed to parse AI response:",e),Error(`Invalid structured output: ${t}`)}}},2875:(e,t,r)=>{r.d(t,{x:()=>l});let o=require("fs/promises");var n=r.n(o),a=r(5315),i=r.n(a);let s=i().join(process.cwd(),"prompts");async function l(e,t){let r=i().join(s,`${e}.md`);try{let e=await n().readFile(r,"utf-8");for(let[r,o]of Object.entries(t)){let t=RegExp(`{{${r}}}`,"g"),n="object"==typeof o?JSON.stringify(o,null,2):String(o);e=e.replace(t,n)}return e}catch(t){throw console.error(`Error loading prompt template: ${e}`,t),Error(`Failed to load prompt template: ${e}`)}}},3697:(e,t,r)=>{r.d(t,{cT:()=>l,Wr:()=>i,_:()=>a,fy:()=>s});let o=require("@prisma/client"),n=global.prisma||new o.PrismaClient({log:["query"]});async function a(e){let{year:t,institution:r,theme:o,themeCategory:a,conviction:i,limit:s=50,page:l=1,search:u}=e,c={};t&&(c.year=t),r&&(c.institution={contains:r}),o&&(c.theme={contains:o}),a&&(c.themeCategory=a),i&&(c.convictionTier=i),u&&(c.OR=[{callText:{contains:u}},{theme:{contains:u}},{institution:{contains:u}}]);let[p,y]=await Promise.all([n.outlookCall.findMany({where:c,take:s,skip:(l-1)*s,orderBy:{id:"asc"}}),n.outlookCall.count({where:c})]);return{data:p,total:y,page:l,limit:s}}async function i(e){return n.outlookCall.findUnique({where:{id:e}})}async function s(){let[e,t,r,o]=await Promise.all([n.outlookCall.count(),n.outlookCall.groupBy({by:["year"],_count:{_all:!0},orderBy:{year:"desc"}}),n.outlookCall.groupBy({by:["themeCategory"],_count:{_all:!0},orderBy:{_count:{_all:"desc"}}}),n.outlookCall.groupBy({by:["institutionCanonical"],_count:{_all:!0},orderBy:{_count:{_all:"desc"}}})]);return{total_records:e,years:t.map(e=>({year:e.year,count:e._count?._all||0})),themes:r.map(e=>({theme:e.themeCategory,count:e._count?._all||0})),institutions:o.map(e=>({institution:e.institutionCanonical,count:e._count?._all||0}))}}async function l(e,t){let[r,o,a,i]=await Promise.all([n.outlookCall.groupBy({by:["themeCategory"],where:{year:e},_count:{_all:!0}}),n.outlookCall.groupBy({by:["themeCategory"],where:{year:t},_count:{_all:!0}}),n.outlookCall.groupBy({by:["institutionCanonical","themeCategory"],where:{year:e}}),n.outlookCall.groupBy({by:["institutionCanonical","themeCategory"],where:{year:t}})]),s=new Map(r.map(e=>[e.themeCategory,e._count?._all||0])),l=new Map(o.map(e=>[e.themeCategory,e._count?._all||0])),u=new Set([...s.keys(),...l.keys()]),c=[],p=[],y=[],_=[];u.forEach(e=>{let t=s.get(e)||0,r=l.get(e)||0,o=r-t;0===t&&r>0?c.push(e):t>0&&0===r?p.push(e):o>0?y.push({theme:e,delta:o}):o<0&&_.push({theme:e,delta:o})});let m=new Map;a.forEach(e=>{let t=m.get(e.institutionCanonical)||[];t.push(e.themeCategory),m.set(e.institutionCanonical,t)});let h=new Map;i.forEach(e=>{let t=h.get(e.institutionCanonical)||[];t.push(e.themeCategory),h.set(e.institutionCanonical,t)});let d=[];for(let e of new Set([...m.keys(),...h.keys()])){let t=m.get(e)||[],r=h.get(e)||[];d.push({institution:e,year1_themes:t,year2_themes:r})}return{year1:e,year2:t,themes_emerged:c,themes_extinct:p,themes_grew:y.sort((e,t)=>t.delta-e.delta),themes_declined:_.sort((e,t)=>e.delta-t.delta),institutional_changes:d.slice(0,50)}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[276,972,870],()=>r(6563));module.exports=o})();