"use strict";(()=>{var e={};e.id=702,e.ids=[702],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5315:e=>{e.exports=require("path")},8574:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>w,requestAsyncStorage:()=>h,routeModule:()=>_,serverHooks:()=>g,staticGenerationAsyncStorage:()=>d});var n={};r.r(n),r.d(n,{POST:()=>y});var o=r(9303),a=r(8716),s=r(670),i=r(7070),l=r(3697),u=r(4574),c=r(2875),p=r(7830),m=r(2460);async function y(e){try{let{year:t,theme_category:r,max_calls:n=50}=await e.json();if(!t)return i.NextResponse.json({error:"Year is required"},{status:400});let o=(0,m.iu)("consensus-summary",{year:t,theme_category:r,max_calls:n}),a=(0,m.q9)(o);if(a)return i.NextResponse.json(a);let{data:s}=await (0,l._)({year:t,themeCategory:r,limit:n});if(0===s.length)return i.NextResponse.json({error:"No calls found for criteria"},{status:404});let y=s.map(e=>`- Institution: ${e.institutionCanonical}
- Theme: ${e.theme}
- View: ${e.callText}`).join("\n\n"),_=await (0,c.x)("consensus-summary",{year:t,count:s.length,calls:y}),h=await (0,u.f)([{role:"system",content:"You are a helpful financial analyst."},{role:"user",content:_}],{temperature:.3}),d=(0,p.a6)(h,p.h6);return(0,m.Zi)(o,d),i.NextResponse.json(d)}catch(e){return console.error("API Error:",e),i.NextResponse.json({error:"Internal Server Error",details:String(e)},{status:500})}}let _=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/ai/summary/route",pathname:"/api/ai/summary",filename:"route",bundlePath:"app/api/ai/summary/route"},resolvedPagePath:"C:\\1 Projects\\secular_forum\\secular_hub\\app\\api\\ai\\summary\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:h,staticGenerationAsyncStorage:d,serverHooks:g}=_,f="/api/ai/summary/route";function w(){return(0,s.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:d})}},2460:(e,t,r)=>{r.d(t,{Zi:()=>a,iu:()=>s,q9:()=>o});let n=new(r(138)).z({max:100,ttl:36e5,allowStale:!1});function o(e){return n.get(e)}function a(e,t,r){n.set(e,t,{ttl:r})}function s(e,t){let r=Object.keys(t).sort().map(e=>`${e}:${JSON.stringify(t[e])}`).join("|");return`${e}|${r}`}},4574:(e,t,r)=>{let n;r.d(t,{f:()=>s});var o=r(1088);let a=!!process.env.AZURE_OPENAI_ENDPOINT;async function s(e,t={}){try{let r=process.env.AZURE_OPENAI_DEPLOYMENT_NAME||"gpt-4";return(await n.chat.completions.create({model:a?r:"gpt-4-turbo",messages:e,temperature:t.temperature??.7,max_tokens:t.max_tokens??1e3})).choices[0].message.content}catch(e){throw console.error("Error calling AI service:",e),e}}a?(process.env.AZURE_OPENAI_KEY&&process.env.AZURE_OPENAI_ENDPOINT||console.warn("Azure OpenAI credentials missing. AI features may not work."),n=new o.r3({apiKey:process.env.AZURE_OPENAI_KEY,endpoint:process.env.AZURE_OPENAI_ENDPOINT,deployment:process.env.AZURE_OPENAI_DEPLOYMENT_NAME,apiVersion:"2024-05-01-preview"})):(process.env.OPENAI_API_KEY||console.warn("OpenAI API Key missing. AI features may not work."),n=new o.ZP({apiKey:process.env.OPENAI_API_KEY}))},7830:(e,t,r)=>{r.d(t,{Cm:()=>i,a6:()=>l,aN:()=>s,h6:()=>o,rw:()=>a});var n=r(6543);let o=n.Ryn({summary:n.Z_8(),key_themes:n.IXX(n.Z_8()),dominant_view:n.Z_8(),notable_outliers:n.IXX(n.Ryn({institution:n.Z_8(),view:n.Z_8()})),confidence:n.KmV(["high","medium","low"])}),a=n.Ryn({sentiment:n.KmV(["bullish","bearish","neutral","mixed"]),confidence:n.Rxh().min(0).max(1),key_phrases:n.IXX(n.Z_8())}),s=n.Ryn({narrative:n.Z_8(),sections:n.Ryn({whats_new:n.Z_8(),whats_intensified:n.Z_8(),whats_faded:n.Z_8(),notable_reversals:n.Z_8()}),key_shifts:n.IXX(n.Ryn({theme:n.Z_8(),direction:n.Z_8(),driver:n.Z_8()}))}),i=n.Ryn({answer:n.Z_8(),sources:n.IXX(n.Ryn({id:n.Z_8(),institution:n.Z_8(),excerpt:n.Z_8()})),follow_up_questions:n.IXX(n.Z_8())});function l(e,t){if(!e)throw Error("Empty AI response");let r=e.trim();if(r.startsWith("```")){let e=r.split("\n");e[0].startsWith("```")&&e.shift(),e[e.length-1].startsWith("```")&&e.pop(),r=e.join("\n")}try{let e=JSON.parse(r);return t.parse(e)}catch(t){throw console.error("Failed to parse AI response:",e),Error(`Invalid structured output: ${t}`)}}},2875:(e,t,r)=>{r.d(t,{x:()=>l});let n=require("fs/promises");var o=r.n(n),a=r(5315),s=r.n(a);let i=s().join(process.cwd(),"prompts");async function l(e,t){let r=s().join(i,`${e}.md`);try{let e=await o().readFile(r,"utf-8");for(let[r,n]of Object.entries(t)){let t=RegExp(`{{${r}}}`,"g"),o="object"==typeof n?JSON.stringify(n,null,2):String(n);e=e.replace(t,o)}return e}catch(t){throw console.error(`Error loading prompt template: ${e}`,t),Error(`Failed to load prompt template: ${e}`)}}},3697:(e,t,r)=>{r.d(t,{cT:()=>l,Wr:()=>s,_:()=>a,fy:()=>i});let n=require("@prisma/client"),o=global.prisma||new n.PrismaClient({log:["query"]});async function a(e){let{year:t,institution:r,theme:n,themeCategory:a,conviction:s,limit:i=50,page:l=1,search:u}=e,c={};t&&(c.year=t),r&&(c.institution={contains:r}),n&&(c.theme={contains:n}),a&&(c.themeCategory=a),s&&(c.convictionTier=s),u&&(c.OR=[{callText:{contains:u}},{theme:{contains:u}},{institution:{contains:u}}]);let[p,m]=await Promise.all([o.outlookCall.findMany({where:c,take:i,skip:(l-1)*i,orderBy:{id:"asc"}}),o.outlookCall.count({where:c})]);return{data:p,total:m,page:l,limit:i}}async function s(e){return o.outlookCall.findUnique({where:{id:e}})}async function i(){let[e,t,r,n]=await Promise.all([o.outlookCall.count(),o.outlookCall.groupBy({by:["year"],_count:{_all:!0},orderBy:{year:"desc"}}),o.outlookCall.groupBy({by:["themeCategory"],_count:{_all:!0},orderBy:{_count:{_all:"desc"}}}),o.outlookCall.groupBy({by:["institutionCanonical"],_count:{_all:!0},orderBy:{_count:{_all:"desc"}}})]);return{total_records:e,years:t.map(e=>({year:e.year,count:e._count?._all||0})),themes:r.map(e=>({theme:e.themeCategory,count:e._count?._all||0})),institutions:n.map(e=>({institution:e.institutionCanonical,count:e._count?._all||0}))}}async function l(e,t){let[r,n,a,s]=await Promise.all([o.outlookCall.groupBy({by:["themeCategory"],where:{year:e},_count:{_all:!0}}),o.outlookCall.groupBy({by:["themeCategory"],where:{year:t},_count:{_all:!0}}),o.outlookCall.groupBy({by:["institutionCanonical","themeCategory"],where:{year:e}}),o.outlookCall.groupBy({by:["institutionCanonical","themeCategory"],where:{year:t}})]),i=new Map(r.map(e=>[e.themeCategory,e._count?._all||0])),l=new Map(n.map(e=>[e.themeCategory,e._count?._all||0])),u=new Set([...i.keys(),...l.keys()]),c=[],p=[],m=[],y=[];u.forEach(e=>{let t=i.get(e)||0,r=l.get(e)||0,n=r-t;0===t&&r>0?c.push(e):t>0&&0===r?p.push(e):n>0?m.push({theme:e,delta:n}):n<0&&y.push({theme:e,delta:n})});let _=new Map;a.forEach(e=>{let t=_.get(e.institutionCanonical)||[];t.push(e.themeCategory),_.set(e.institutionCanonical,t)});let h=new Map;s.forEach(e=>{let t=h.get(e.institutionCanonical)||[];t.push(e.themeCategory),h.set(e.institutionCanonical,t)});let d=[];for(let e of new Set([..._.keys(),...h.keys()])){let t=_.get(e)||[],r=h.get(e)||[];d.push({institution:e,year1_themes:t,year2_themes:r})}return{year1:e,year2:t,themes_emerged:c,themes_extinct:p,themes_grew:m.sort((e,t)=>t.delta-e.delta),themes_declined:y.sort((e,t)=>e.delta-t.delta),institutional_changes:d.slice(0,50)}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[276,972,870],()=>r(8574));module.exports=n})();